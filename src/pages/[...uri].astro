---
export const prerender = true;
import MainLayout from "../layouts/MainLayout.astro";
import Single from "../components/templates/Single.astro";
import Archive from "../components/templates/Archive.astro";
import { getNodeByURI, getAllUris } from "../lib/api";

const uri = `/${Astro.params.uri}/`;
let data;
let node;

try {
    data = await getNodeByURI(uri);
    node = data?.nodeByUri;
    
    if (!node) {
        return Astro.redirect('/404');
    }
} catch (error) {
    console.error('Error fetching node data:', error);
    return Astro.redirect('/404');
}

export async function getStaticPaths(){
    return await getAllUris();
}

function resolveContentTemplate(node){ 
    let template;
    let type;
    switch(node.__typename){
        case 'Post':
            template = Single;
            type = 'Post';
            break; 
        case 'Page':
            template = Single;
            type = 'Page';
            break; 
        case 'Event':
            template = Single;
            type = 'Event';
            break;
        case 'Category':
            template = Archive;
            type = 'Category';
            break; 
        case 'Tag':
            template = Archive;
            type = 'Tag';
            break; 
        default: 
            template = Single;
            type = 'Post';
    }

    return { template, type };
}

const { template: Template, type } = resolveContentTemplate(node)

---

<MainLayout 
 title={ node.title || node.name}
 description={ node.excerpt || node.content }
>
        <Template node={node} type={type} posts={node.posts?.nodes || []}></Template>
</MainLayout>
