---
// Mobile menu component for Astro
import { navQuery } from "../lib/api";

// Fetch navigation data with error handling
let navData;
try {
    navData = await navQuery();
} catch (error) {
    console.error('Error fetching navigation data:', error);
    navData = { 
        menus: { nodes: [] }, 
        pages: { nodes: [] },
        generalSettings: { title: 'Site', description: '' } 
    };
}

const { menus, pages, generalSettings } = navData;
const primaryMenu = menus?.nodes?.[0] || null;
const allPages = pages?.nodes || [];
---

<div id="mobile-menu" class="fixed inset-y-0 right-0 z-50 w-full max-w-sm bg-background shadow-xl transform translate-x-full transition-transform duration-300 ease-in-out">
    <div class="flex flex-col h-full">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-border/40">
            <h2 class="text-lg font-semibold text-foreground">Menu</h2>
            <button
                id="close-mobile-menu"
                class="inline-flex h-8 w-8 items-center justify-center rounded-md border border-border bg-background text-foreground hover:bg-accent hover:text-accent-foreground transition-colors"
                aria-label="Close menu"
            >
                <svg
                    class="h-4 w-4"
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <path d="M18 6 6 18"/>
                    <path d="m6 6 12 12"/>
                </svg>
            </button>
        </div>
        
        <!-- Navigation Links -->
        <nav class="flex-1 p-4 space-y-2">
            <a href="/" class="block px-4 py-3 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-md transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                        <polyline points="9,22 9,12 15,12 15,22"/>
                    </svg>
                    <span>Home</span>
                </div>
            </a>
            
            <a href="/posts" class="block px-4 py-3 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-md transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" x2="8" y1="13" y2="13"/>
                        <line x1="16" x2="8" y1="17" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>
                    <span>Posts</span>
                </div>
            </a>
            
            <a href="/events" class="block px-4 py-3 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-md transition-colors">
                <div class="flex items-center space-x-3">
                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M8 2v4"/>
                        <path d="M16 2v4"/>
                        <rect width="18" height="18" x="3" y="4" rx="2"/>
                        <path d="M3 10h18"/>
                    </svg>
                    <span>Events</span>
                </div>
            </a>
            
            {allPages.map((page) => (
                <a href={page.uri} class="block px-4 py-3 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-md transition-colors">
                    <div class="flex items-center space-x-3">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                            <polyline points="14,2 14,8 20,8"/>
                        </svg>
                        <span>{page.title}</span>
                    </div>
                </a>
            ))}
            
            {primaryMenu && primaryMenu.menuItems?.nodes?.map((item) => (
                <a href={item.url} class="block px-4 py-3 text-sm font-medium text-foreground/70 hover:text-foreground hover:bg-accent rounded-md transition-colors">
                    <div class="flex items-center space-x-3">
                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3h18v18H3z"/>
                            <path d="M9 9h6v6H9z"/>
                        </svg>
                        <span>{item.label}</span>
                    </div>
                </a>
            ))}
        </nav>
        
        <!-- Footer -->
        <div class="p-4 border-t border-border/40">
            <div class="text-xs text-foreground/60 text-center">
                AstroWP Starter
            </div>
        </div>
    </div>
</div>

<!-- Overlay -->
<div id="mobile-menu-overlay" class="fixed inset-0 z-40 bg-background/80 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300"></div>

<script>
    // Mobile menu functionality
    const mobileMenuButton = document.getElementById('mobile-menu-button');
    const mobileMenu = document.getElementById('mobile-menu');
    const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');
    const closeMobileMenu = document.getElementById('close-mobile-menu');

    function openMobileMenu() {
        if (mobileMenu && mobileMenuOverlay) {
            mobileMenu.classList.remove('translate-x-full');
            mobileMenuOverlay.classList.remove('opacity-0', 'pointer-events-none');
            document.body.style.overflow = 'hidden';
        }
    }

    function closeMobileMenuFunc() {
        if (mobileMenu && mobileMenuOverlay) {
            mobileMenu.classList.add('translate-x-full');
            mobileMenuOverlay.classList.add('opacity-0', 'pointer-events-none');
            document.body.style.overflow = '';
        }
    }

    // Event listeners
    if (mobileMenuButton) {
        mobileMenuButton.addEventListener('click', openMobileMenu);
    }

    if (closeMobileMenu) {
        closeMobileMenu.addEventListener('click', closeMobileMenuFunc);
    }

    if (mobileMenuOverlay) {
        mobileMenuOverlay.addEventListener('click', closeMobileMenuFunc);
    }

    // Close on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeMobileMenuFunc();
        }
    });
</script>
